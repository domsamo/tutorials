{
  "name": "My workflow 5",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        -180
      ],
      "id": "cb749bf1-2f2e-47d5-9d58-c068a712793e",
      "name": "When chat message received",
      "webhookId": "edcf86cd-fc03-435e-862f-4e0903a589c4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When chat message received').first().json.chatInput }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=DATABASE SCHEMA:\n{{ $json.schema }}\n\nLooking at the database schema above, convert a user's question into a SQL query to fetch data from the database. return the SQL query only "
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1476,
        -180
      ],
      "id": "44e2a1ff-04db-44ad-8a2f-82d80c25effb",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1504,
        40
      ],
      "id": "b1cac065-8c4e-4dfe-88b0-994d1720dfaf",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "96yvOWGWa0cR3yGk",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.output.query }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1852,
        -180
      ],
      "id": "ebbf1d98-142a-4d4b-af3c-dc2b08d115b3",
      "name": "Execute a SQL query",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "QWnUbD61gdh6Jm8d",
          "name": "jasonkang14@gmail.com"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n\t\"type\": \"object\",\n\t\"properties\": {\n\t\t\"query\": {\n\t\t\t\"type\": \"string\"\n\t\t}\n\t\t\n\t}\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        1624,
        40
      ],
      "id": "81ef557d-4f96-4346-a785-c30fafd6fd89",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=QUERY RESULT:\n{{ JSON.stringify($json) }}\n\nOriginal Question:  {{ $('When chat message received').first().json.chatInput }}",
        "messages": {
          "messageValues": [
            {
              "message": "Look at the query result and the user's question and return a user friendly message"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        2072,
        -180
      ],
      "id": "116c737c-ee9d-43d4-b1b8-366cd1e486f5",
      "name": "Basic LLM Chain1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2160,
        40
      ],
      "id": "c3feb0fd-723e-4858-9ac8-6beebe665772",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "96yvOWGWa0cR3yGk",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let schema = ''\n\nfor (const item of $input.all()) {\n  schema += `${item.json.create_statement}\\n\\n`\n}\n\nreturn [{schema}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1256,
        -180
      ],
      "id": "95dcceff-0eb4-4033-b6e0-f9551205517b",
      "name": "Code"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    col.table_name,\n    COALESCE(obj_description(c.oid), 'No description available') AS table_description,\n    string_agg(col.column_name, ', ' ORDER BY col.ordinal_position) AS all_columns\nFROM information_schema.columns col\nLEFT JOIN pg_class c ON c.relname = col.table_name\nLEFT JOIN pg_namespace n ON n.oid = c.relnamespace\nWHERE col.table_schema = 'public'\nAND n.nspname = 'public'\nGROUP BY col.table_name, c.oid\nORDER BY col.table_name;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        220,
        -180
      ],
      "id": "78c50ac7-cf97-4fca-83b5-904d61c766e5",
      "name": "테이블 이름 가져오기",
      "credentials": {
        "postgres": {
          "id": "QWnUbD61gdh6Jm8d",
          "name": "jasonkang14@gmail.com"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let schema = ''\n\nfor (const item of $input.all()) {\n  schema += `tableName: ${item.json.table_name}\ntableDescription: ${item.json.table_description}\ncolumnList: ${item.json.all_columns}`\n}\n\nreturn [{schema}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        440,
        -180
      ],
      "id": "c196c0f2-69fe-419e-877b-caf5cb9af0c8",
      "name": "Code1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        688,
        40
      ],
      "id": "e5ced169-cc96-44f8-9df9-f861d7f30b27",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "96yvOWGWa0cR3yGk",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n\t\"type\": \"object\",\n\t\"properties\": {\n\t\t\"tables\": {\n\t\t\t\"type\": \"array\",\n\t\t\t\"tableName\": {\n\t\t\t\t\"type\": \"string\"\n\t\t\t}\n\t\t}\n\t}\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        808,
        40
      ],
      "id": "65d72a57-260c-4385-93b4-25ae40fc487e",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    'CREATE TABLE ' || table_name || ' (' || E'\\n' ||\n    string_agg(\n        '    ' || column_name || ' ' || \n        CASE \n            WHEN data_type = 'character varying' THEN 'VARCHAR(' || character_maximum_length || ')'\n            WHEN data_type = 'integer' AND column_default LIKE 'nextval%' THEN 'SERIAL PRIMARY KEY'\n            WHEN data_type = 'numeric' THEN 'DECIMAL(' || numeric_precision || ',' || numeric_scale || ')'\n            WHEN data_type = 'timestamp without time zone' THEN 'TIMESTAMP'\n            WHEN data_type = 'boolean' THEN 'BOOLEAN'\n            ELSE UPPER(data_type)\n        END ||\n        CASE WHEN is_nullable = 'NO' AND column_default NOT LIKE 'nextval%' THEN ' NOT NULL' ELSE '' END ||\n        CASE WHEN column_default IS NOT NULL AND column_default NOT LIKE 'nextval%' \n             THEN ' DEFAULT ' || column_default ELSE '' END,\n        E',\\n' ORDER BY ordinal_position\n    ) || E'\\n' || ');' || E'\\n\\n' AS create_statement\nFROM information_schema.columns \nWHERE table_schema = 'public'\n  AND table_name IN ({{ $json.output.tables.map((tableName) => `'${tableName}'`) }})\nGROUP BY table_name\nORDER BY table_name;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1036,
        -180
      ],
      "id": "08e1d674-3050-449c-83b0-f6e88c7a701e",
      "name": "스키마 가져오기",
      "credentials": {
        "postgres": {
          "id": "zf20pLcO8Fj9JJj2",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('When chat message received').first().json.chatInput }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=TABLE DESCRIPTION:\n{{ $json.schema }}\n\nBy looking at the table description above, which contains information about the name of tables and their relative descriptions along with the list of columns, return the list of names of the tables that you need to access in order to retrieve data related to the user's question"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        660,
        -180
      ],
      "id": "41b56f99-064c-49f4-9289-d1f8dbd279e2",
      "name": "테이블 리스트 추출"
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "테이블 이름 가져오기",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "테이블 이름 가져오기": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "테이블 리스트 추출",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "테이블 리스트 추출",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "테이블 리스트 추출",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "스키마 가져오기": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "테이블 리스트 추출": {
      "main": [
        [
          {
            "node": "스키마 가져오기",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "07256146-6031-4d50-8c90-be7d18e95754",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d8569e51104cfa451bd455a95dbfd98c913c0704d025656c6d11ba72aeb59663"
  },
  "id": "fxygfMN2T9pZM1qL",
  "tags": []
}